<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Camera + IMU Frame Extractor</title>
    <!-- JSZip (for creating ZIP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #f0f0f0;
      }
      #preview-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        background: #000;
        margin-top: 1rem;
        overflow: hidden;
      }
      video {
        width: 100%;
        height: auto;
        transform: scaleX(-1); /* mirror for front-facing camera */
      }
      #controls {
        margin: 1rem;
        display: flex;
        gap: 1rem;
      }
      button {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        background: #007aff;
        color: #fff;
      }
      button:disabled {
        background: #999;
      }
      #status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #333;
      }
    </style>
  </head>
  <body>
    <h2>Camera + IMU Frame Extractor</h2>
    <div id="preview-container">
      <video id="videoPreview" autoplay playsinline></video>
    </div>
    <div id="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>
    <div id="status">Idle</div>

    <!-- Hidden canvas for capturing frames -->
    <canvas id="captureCanvas" style="display: none"></canvas>

    <script>
      (function () {
        // References to UI elements
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const statusDiv = document.getElementById("status");
        const video = document.getElementById("videoPreview");
        const canvas = document.getElementById("captureCanvas");
        const ctx = canvas.getContext("2d");

        // Configuration
        const FRAME_INTERVAL = 30; // Extract once every 30 frames

        // State variables
        let stream = null;
        let rafId = null;
        let frameCount = 0;
        let running = false;
        let latestIMU = { alpha: null, beta: null, gamma: null };
        let images = []; // { filename: string, blob: Blob }
        let metadata = []; // { timestamp: number, filename: string, alpha: number, beta: number, gamma: number }

        // Request permission for iOS device orientation (if needed)
        function requestIMUPermission() {
          if (
            typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function"
          ) {
            return DeviceOrientationEvent.requestPermission().then((resp) => {
              if (resp === "granted") {
                return true;
              } else {
                alert("IMU permission denied. Cannot read device orientation.");
                return false;
              }
            });
          } else {
            // Non-iOS or already allowed
            return Promise.resolve(true);
          }
        }

        // Set up IMU listener
        function startIMUListener() {
          window.addEventListener("deviceorientation", imuHandler, true);
        }
        function stopIMUListener() {
          window.removeEventListener("deviceorientation", imuHandler, true);
        }
        function imuHandler(event) {
          // alpha, beta, gamma in degrees
          latestIMU.alpha = event.alpha;
          latestIMU.beta = event.beta;
          latestIMU.gamma = event.gamma;
        }

        // Start camera and capture loop
        async function startCapture() {
          statusDiv.textContent = "Initializing...";
          // 1. Ask for IMU permission if needed
          const imuAllowed = await requestIMUPermission();
          if (!imuAllowed) {
            statusDiv.textContent = "IMU permission denied.";
            return;
          }
          // 2. Request camera
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
              audio: false,
            });
          } catch (err) {
            console.error("Failed to get camera:", err);
            alert("无法访问摄像头。请检查权限。");
            statusDiv.textContent = "Camera access denied.";
            return;
          }
          video.srcObject = stream;

          // Once video metadata is loaded, set canvas size
          video.addEventListener(
            "loadedmetadata",
            () => {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              // Start IMU listener
              startIMUListener();
              // Start frame loop
              running = true;
              frameCount = 0;
              loopCapture();
              startBtn.disabled = true;
              stopBtn.disabled = false;
              statusDiv.textContent = "Running…";
            },
            { once: true }
          );
        }

        // Capture loop using requestAnimationFrame
        function loopCapture() {
          if (!running) return;
          // Draw current video frame onto canvas
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          frameCount++;

          if (frameCount % FRAME_INTERVAL === 0) {
            // Time to capture
            const ts = Date.now();
            const filename = `${ts}.png`;
            // Convert canvas to Blob
            canvas.toBlob(
              (blob) => {
                images.push({ filename, blob });
                // Record metadata snapshot
                metadata.push({
                  timestamp: ts,
                  filename,
                  alpha: latestIMU.alpha,
                  beta: latestIMU.beta,
                  gamma: latestIMU.gamma,
                });
                statusDiv.textContent = `Captured #${
                  images.length
                } @ ${new Date(ts).toLocaleTimeString()}`;
              },
              "image/png",
              0.92
            );
          }

          rafId = requestAnimationFrame(loopCapture);
        }

        // Stop everything and generate ZIP
        async function stopCapture() {
          running = false;
          stopBtn.disabled = true;
          statusDiv.textContent = "Stopping…";

          // 1. Stop animation loop
          if (rafId) {
            cancelAnimationFrame(rafId);
            rafId = null;
          }
          // 2. Stop IMU listener
          stopIMUListener();
          // 3. Stop camera tracks
          if (stream) {
            stream.getTracks().forEach((t) => t.stop());
            stream = null;
          }

          // 4. Build CSV for metadata
          let csvContent = "timestamp,filename,alpha,beta,gamma\n";
          metadata.forEach((m) => {
            csvContent += `${m.timestamp},${m.filename},${m.alpha},${m.beta},${m.gamma}\n`;
          });

          // 5. Create ZIP
          const zip = new JSZip();
          // Add each image blob
          images.forEach((img) => {
            zip.file(img.filename, img.blob);
          });
          // Add metadata CSV
          zip.file("log.csv", csvContent);

          statusDiv.textContent = "Generating ZIP…";
          try {
            const zipBlob = await zip.generateAsync({ type: "blob" });
            // Trigger download
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "captured_data.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            statusDiv.textContent =
              "Done! 文件已下载到本地 (captured_data.zip)";
          } catch (err) {
            console.error("ZIP generation failed:", err);
            statusDiv.textContent = "ZIP 生成失败。";
          } finally {
            // Reset UI
            startBtn.disabled = false;
          }
        }

        // Wire up buttons
        startBtn.addEventListener("click", startCapture);
        stopBtn.addEventListener("click", stopCapture);
      })();
    </script>
  </body>
</html>
